\documentclass[a4paper, notitlepage]{article}
\usepackage{fullpage}
\usepackage{listings}
\usepackage{color}
\usepackage{courier}
 
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{ltgray}{rgb}{0.9,0.9,0.9}
\definecolor{mauve}{rgb}{0.58,0,0.82}
 
\lstset{ %
  language=XML,
  basicstyle=\ttfamily,           % the size of the fonts that are used for the code
  numbers=left,                   % where to put the line-numbers
  numberstyle=\tiny\color{gray},  % the style that is used for the line-numbers
  stepnumber=1,                   % the step between two line-numbers. If it's 1, each line 
                                  % will be numbered
  numbersep=5pt,                  % how far the line-numbers are from the code
  backgroundcolor=\color{ltgray},      % choose the background color. You must add \usepackage{color}
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,                 % show tabs within strings adding particular underscores
  rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
  tabsize=2,                      % sets default tabsize to 2 spaces
  captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  keywordstyle=\color{blue},          % keyword style
  commentstyle=\color{dkgreen},       % comment style
  stringstyle=\color{mauve},         % string literal style
  escapeinside={\%*}{*)},            % if you want to add a comment within your code
}

\begin{document}

\title{IN4331 Web Data Management, assignment 1 \\
Managing an XML Database with eXist}
\author{Koen Boes (???) and Zmitser Zhaleznichenka (4134575)}
\date{\today}
\maketitle

\setcounter{secnumdepth}{0}

\section{Exercises}

\subsection{XPath}

\begin{enumerate}
\item 
  \emph{Display all \lstinline{title} elements.} 
  
Query: 
  
\begin{lstlisting}
<titles>
  {doc('/db/movies/movies.xml')/movies//title}
</titles>
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<titles>
  <title>A History of Violence</title>
  <title>Heat</title>
  <title>Unforgiven</title>
  <title>Match Point</title>
  <title>Lost in Translation</title>
  <title>Marie Antoinette</title>
  <title>Spider-Man</title>
</titles>
\end{lstlisting}
  
\item 
  \emph{Display all movie titles, i.e. the textual value of \lstinline{title} elements.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies//title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
A History of Violence
Heat
Unforgiven
Match Point
Lost in Translation
Marie Antoinette
Spider-Man
\end{lstlisting}  

\item 
  \emph{Display the titles of the movies published after 2000.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[year > 2000]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
A History of Violence
Match Point
Lost in Translation
Marie Antoinette
Spider-Man
\end{lstlisting}  

\item 
  \emph{Show summary of \textbf{Spider-Man}.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[title = "Spider-Man"]/summary/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
On a school field trip, Peter Parker (Maguire) is bitten by a genetically modified spider. He wakes up the next morning with incredible powers. After witnessing the death of his uncle (Robertson), Parkers decides to put his new skills to use in order to rid the city of evil, but someone else has other plans. The Green Goblin (Dafoe) sees Spider-Man as a threat and must dispose of him. Even if it means the Goblin has to target Parker Aunt (Harris) and the girl he secretly pines for (Dunst).
\end{lstlisting}  

\item 
  \emph{Who is the director of \textbf{Heat}?} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[title = "Heat"]/director
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<director>
  <last_name>Mann</last_name>
  <first_name>Michael</first_name>
  <birth_date>1943</birth_date>
</director>
\end{lstlisting}  
  
\item 
  \emph{Display titles of the movies featuring Kirsten Dunst.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie/actor[last_name = "Dunst"]/../title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Marie Antoinette
Spider-Man
\end{lstlisting}   

\item
  \emph{Which movies have a summary?}
  
Query:
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[count(summary) > 0]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
A History of Violence
Heat
Unforgiven
Match Point
Marie Antoinette
Spider-Man
\end{lstlisting}


\item
  \emph{Which movies do \textbf{not} have a summary?}
  
Query:
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[count(summary) = 0]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Lost in Translation
\end{lstlisting}

\item
  \emph{Which titles of the movies published more than 5 years ago? }
  
Query:
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[year < (year-from-date(current-date()) - 5)]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
A History of Violence
Heat
Unforgiven
Match Point
Lost in Translation
Marie Antoinette
Spider-Man
\end{lstlisting}

\item
  \emph{ What was the role of Clint Eastwood in \textbf{Unforgiven}? }
  
Query:
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[title = 'Unforgiven']/actor[last_name = 'Eastwood' and first_name = 'Clint']/role/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
William 'Bill' Munny
\end{lstlisting}
  

\item
  \emph{ What is the \lstinline{last} movie in the document? }
  
Query:
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[last()]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Spider-Man
\end{lstlisting} 

\item 
  \emph{Display title of the film that immediately precedes \textbf{Marie Antoinette} in the document.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[title="Marie Antoinette"]/preceding-sibling::movie[position()=last()]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Lost in Translation
\end{lstlisting}   

\item 
  \emph{Get the movies whose title contains a "V".} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie/title/text()[fn:contains(.,"V")]
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
A History of Violence
\end{lstlisting}   

\item 
  \emph{Get the movies whose cast consists of exactly three actors.} 
  
Query: 
  
\begin{lstlisting}
doc('/db/movies/movies.xml')/movies/movie[fn:count(actor) = 3]/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Unforgiven
Spider-Man
\end{lstlisting}   
  
\end{enumerate}


\subsection{XQuery}

\begin{enumerate}
\item  
  \emph{List the movies published after 2002, including their title and year.} 
  
Query: 
  
\begin{lstlisting}
let $ms:=doc("movies/movies_alone.xml"),
    $as:=doc("movies/artists_alone.xml")

for $m in $ms/movies/movie
where $m/year > 2002
return
<movie>
	{$m/*[local-name()=("title","year")]}
</movie>
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<movie>
	<title>A History of Violence</title>
	<year>2005</year>
</movie>
<movie>
	<title>Match Point</title>
	<year>2005</year>
</movie>
<movie>
	<title>Lost in Translation</title>
	<year>2003</year>
</movie>
<movie>
	<title>Marie Antoinette</title>
	<year>2006</year>
</movie>
\end{lstlisting} 

\item  
  \emph{Create a flat list of all the title-role pairs, with each pair enclosed in a ``result'' element.} 
  
Query: 
  
\begin{lstlisting}
let $ms:=doc("movies/movies_alone.xml"),
    $as:=doc("movies/artists_alone.xml")

return
<results>
{     
    for $m in $ms/movies/movie
    for $a in $m/actor
    return
    <result>
        {$m/title}
        <role>{$a/@role/string()}</role>
    </result>    
}
</results>
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<results>
	<result>
		<title>A History of Violence</title>
		<role>Tom Stall</role>
	</result>
	<result>
		<title>A History of Violence</title>
		<role>Eddie Stall</role>
	</result>
	<result>
		<title>A History of Violence</title>
		<role>Carl Fogarty</role>
	</result>
	<result>
		<title>A History of Violence</title>
		<role>Richie Cusack</role>
	</result>
	<result>
		<title>Heat</title>
		<role>Lt. Vincent Hanna</role>
	</result>
	<result>
		<title>Heat</title>
		<role>Neil McCauley</role>
	</result>
	<result>
		<title>Heat</title>
		<role>Chris Shiherlis</role>
	</result>
	<result>
		<title>Heat</title>
		<role>Nate</role>
	</result>
	<result>
		<title>Unforgiven</title>
		<role>William 'Bill' Munny</role>
	</result>
	<result>
		<title>Unforgiven</title>
		<role>Little Bill Daggett</role>
	</result>
	<result>
		<title>Unforgiven</title>
		<role>Ned Logan</role>
	</result>
	<result>
		<title>Match Point</title>
		<role>Chris Wilton</role>
	</result>
	<result>
		<title>Match Point</title>
		<role>Nola Rice</role>
	</result>
	<result>
		<title>Lost in Translation</title>
		<role>Charlotte</role>
	</result>
	<result>
		<title>Lost in Translation</title>
		<role>Bob Harris</role>
	</result>
	<result>
		<title>Marie Antoinette</title>
		<role>Marie Antoinette</role>
	</result>
	<result>
		<title>Marie Antoinette</title>
		<role>Louis XVI</role>
	</result>
	<result>
		<title>Spider-Man</title>
		<role>Mary Jane Watson</role>
	</result>
	<result>
		<title>Spider-Man</title>
		<role>Spider-Man / Peter Parker</role>
	</result>
	<result>
		<title>Spider-Man</title>
		<role>Green Goblin / Norman Osborn</role>
	</result>
</results>
\end{lstlisting} 

\item  
  \emph{Give the title of movies where the director is also one of the actors.} 
  
Query: 
  
\begin{lstlisting}
let $ms:=doc("movies/movies_alone.xml"),
    $as:=doc("movies/artists_alone.xml")
    
for $m in $ms/movies/movie
where $m/director/@id = $m/actor/@id
return
$m/title/text()
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
Unforgiven
\end{lstlisting} 

\item  
  \emph{Show the movies, grouped by genre.} 
  
Query: 
  
\begin{lstlisting}
let $ms:=doc("movies/movies_alone.xml"),
    $as:=doc("movies/artists_alone.xml")
    
    
for $g in distinct-values($ms/movies/movie/genre)
return 
<genre name="{$g}">  
{
    for $m in $ms/movies/movie
    where $m/genre/text() = $g
    return 
    $m
}
</genre>
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<genre name="Crime">
	<movie>
		<title>A History of Violence</title>
		<year>2005</year>
		<country>USA</country>
		<genre>Crime</genre>
		<summary>Tom Stall, a humble family man and owner of a popular neighborhood restaurant, lives a quiet but fulfilling existence in the Midwest. One night Tom foils a crime at his place of business and, to his chagrin, is plastered all over the news for his heroics. Following this, mysterious people follow the Stalls' every move, concerning Tom more than anyone else. As this situation is confronted, more lurks out over where all these occurrences have stemmed from compromising his marriage, family relationship and the main characters' former relations in the process.</summary>
		<director id="1"/>
		<actor id="2" role="Tom Stall"/>
		<actor id="3" role="Eddie Stall"/>
		<actor id="4" role="Carl Fogarty"/>
		<actor id="5" role="Richie Cusack"/>
	</movie>
	<movie>
		<title>Heat</title>
		<year>1995</year>
		<country>USA</country>
		<genre>Crime</genre>
		<summary>Hunters and their prey--Neil and his professional criminal crew hunt to score big money targets (banks, vaults, armored cars) and are, in turn, hunted by Lt. Vincent Hanna and his team of cops in the Robbery/Homicide police division. A botched job puts Hanna onto their trail while they regroup and try to put together one last big 'retirement' score. Neil and Vincent are similar in many ways, including their troubled personal lives. At a crucial moment in his life, Neil disobeys the dictum taught to him long ago by his criminal mentor--'Never have anything in your life that you can't walk out on in thirty seconds flat, if you spot the heat coming around the corner'--as he falls in love. Thus the stage is set for the suspenseful ending.... </summary>
		<director id="6"/>
		<actor id="7" role="Lt. Vincent Hanna"/>
		<actor id="8" role="Neil McCauley"/>
		<actor id="9" role="Chris Shiherlis"/>
		<actor id="10" role="Nate"/>
	</movie>
	<movie>
		<title>Match Point</title>
		<year>2005</year>
		<country>USA</country>
		<genre>Crime</genre>
		<summary>Chris Wilton is a former tennis pro, looking to find work as an instructor. He meets Tom Hewett, a well-off pretty boy. Tom's sister Chloe falls in love with Chris but Chris has his eyes on Tom's fiancée, the luscious Nola. Both Chris and Nola know it's wrong but what could be more right than love? Chris tries to juggle both women but at some point, he must choose between them...</summary>
		<director id="14"/>
		<actor id="15" role="Chris Wilton"/>
		<actor id="16" role="Nola Rice"/>
	</movie>
</genre>
<genre name="Western">
	<movie>
		<title>Unforgiven</title>
		<year>1992</year>
		<country>USA</country>
		<genre>Western</genre>
		<summary>The town of Big Whisky is full of normal people trying to lead quiet lives. Cowboys try to make a living. Sheriff 'Little Bill' tries to build a house and keep a heavy-handed order. The town whores just try to get by.Then a couple of cowboys cut up a whore. Unsatisfied with Bill's justice, the prostitutes put a bounty on the cowboys. The bounty attracts a young gun billing himself as 'The Schofield Kid', and aging killer William Munny. Munny reformed for his young wife, and has been raising crops and two children in peace. But his wife is gone. Farm life is hard. And Munny is no good at it. So he calls his old partner Ned, saddles his ornery nag, and rides off to kill one more time, blurring the lines between heroism and villainy, man and myth.</summary>
		<director id="11"/>
		<actor id="11" role="William 'Bill' Munny"/>
		<actor id="12" role="Little Bill Daggett"/>
		<actor id="13" role="Ned Logan"/>
	</movie>
</genre>
<genre name="Drama">
	<movie>
		<title>Lost in Translation</title>
		<year>2003</year>
		<country>USA</country>
		<genre>Drama</genre>
		<director id="17"/>
		<actor id="16" role="Charlotte"/>
		<actor id="18" role="Bob Harris"/>
	</movie>
	<movie>
		<title>Marie Antoinette</title>
		<year>2006</year>
		<country>USA</country>
		<genre>Drama</genre>
		<summary>Based on Antonia Fraser's book about the ill-fated Archduchess of Austria and later Queen of France, 'Marie Antoinette' tells the story of the most misunderstood and abused woman in history, from her birth in Imperial Austria to her later life in France. </summary>
		<director id="17"/>
		<actor id="19" role="Marie Antoinette"/>
		<actor id="20" role="Louis XVI"/>
	</movie>
</genre>
<genre name="Action">
	<movie>
		<title>Spider-Man</title>
		<year>2002</year>
		<country>USA</country>
		<genre>Action</genre>
		<summary>On a school field trip, Peter Parker (Maguire) is bitten by a genetically modified spider. He wakes up the next morning with incredible powers. After witnessing the death of his uncle (Robertson), Parkers decides to put his new skills to use in order to rid the city of evil, but someone else has other plans. The Green Goblin (Dafoe) sees Spider-Man as a threat and must dispose of him. Even if it means the Goblin has to target Parker's Aunt (Harris) and the girl he secretly pines for (Dunst) </summary>
		<director id="21"/>
		<actor id="19" role="Mary Jane Watson"/>
		<actor id="22" role="Spider-Man / Peter Parker"/>
		<actor id="23" role="Green Goblin / Norman Osborn"/>
	</movie>
</genre>
\end{lstlisting} 

\item  
  \emph{ For each distinct actor's id in movies\_alone.xml, show the titles of the movies where this actor plays a role.} 
  
Query: 
  
\begin{lstlisting}
let $ms:=doc("movies/movies_alone.xml"),
    $as:=doc("movies/artists_alone.xml")
    
for $aid in distinct-values($ms/movies/movie/actor/@id)
return   
    for $m in $ms/movies/movie
    where $m/actor/@id/string() = $aid
    return 
        <actor>
            {$aid},
            {$m/title}
        </actor>
\end{lstlisting}
  
Output:
  
\begin{lstlisting}
<actor>2,
	<title>A History of Violence</title>
</actor>
<actor>3,
	<title>A History of Violence</title>
</actor>
<actor>4,
	<title>A History of Violence</title>
</actor>
<actor>5,
	<title>A History of Violence</title>
</actor>
<actor>7,
	<title>Heat</title>
</actor>
<actor>8,
	<title>Heat</title>
</actor>
<actor>9,
	<title>Heat</title>
</actor>
<actor>10,
	<title>Heat</title>
</actor>
<actor>11,
	<title>Unforgiven</title>
</actor>
<actor>12,
	<title>Unforgiven</title>
</actor>
\end{lstlisting} 

\end{enumerate}

\end{document}
